<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data noupdate="1">
        
        <!-- Bot com IdentificaÃ§Ã£o de Partner -->
        <record id="demo_bot_partner_identify" model="wa.bot">
            <field name="name">Bot IdentificaÃ§Ã£o Partner</field>
            <field name="sequence">2</field>
            <field name="active">True</field>
            <field name="init_mode">auto</field>
            <field name="session_timeout">30</field>
            <field name="greeting_enabled">False</field>
        </record>

        <!-- Step 1: Action - Identificar Partner pelo Telefone -->
        <record id="demo_flow_identify_partner" model="wa.bot.flow">
            <field name="bot_id" ref="demo_bot_partner_identify"/>
            <field name="sequence">10</field>
            <field name="name">Identificar Partner</field>
            <field name="step_type">action</field>
            <field name="delay">0</field>
            <field name="action_code">
# Pegar o telefone da sessÃ£o
phone = session.phone

# Limpar o telefone (remover caracteres especiais)
import re
phone_clean = re.sub(r'[^\d]', '', phone)

# Buscar partner pelo telefone
Partner = env['res.partner']

# Tentar encontrar por phone ou mobile
partner = Partner.search([
    '|',
    ('phone', 'ilike', phone_clean[-9:]),  # Ãšltimos 9 dÃ­gitos
    ('mobile', 'ilike', phone_clean[-9:])
], limit=1)

# Salvar informaÃ§Ãµes na sessÃ£o
if partner:
    session.set_variable('partner_id', partner.id)
    session.set_variable('partner_name', partner.name)
    session.set_variable('partner_found', True)
else:
    session.set_variable('partner_found', False)
    session.set_variable('partner_name', 'Cliente')
            </field>
        </record>

        <!-- Step 2: Condition - Verificar se Partner foi Encontrado -->
        <record id="demo_flow_check_partner" model="wa.bot.flow">
            <field name="bot_id" ref="demo_bot_partner_identify"/>
            <field name="sequence">20</field>
            <field name="name">Verificar se Partner Existe</field>
            <field name="step_type">condition</field>
            <field name="delay">0</field>
            <field name="condition_type">variable</field>
            <field name="condition_variable">partner_found</field>
            <field name="condition_operator">==</field>
            <field name="condition_value">True</field>
        </record>

        <!-- Step 3a: Message - SaudaÃ§Ã£o Personalizada (Partner Encontrado) -->
        <record id="demo_flow_greeting_known" model="wa.bot.flow">
            <field name="bot_id" ref="demo_bot_partner_identify"/>
            <field name="sequence">30</field>
            <field name="name">SaudaÃ§Ã£o Personalizada</field>
            <field name="step_type">message</field>
            <field name="delay">1</field>
            <field name="message">Oi *{partner_name}*! ğŸ‘‹

JÃ¡ te identifiquei aqui nos nossos registros! 

Como posso te ajudar nesse momento?

Precisa falar com nosso time de:

1ï¸âƒ£ - Suporte
2ï¸âƒ£ - Comercial  
3ï¸âƒ£ - Financeiro

Digite o nÃºmero da opÃ§Ã£o desejada.</field>
        </record>

        <!-- Step 3b: Message - SaudaÃ§Ã£o GenÃ©rica (Partner NÃƒO Encontrado) -->
        <record id="demo_flow_greeting_unknown" model="wa.bot.flow">
            <field name="bot_id" ref="demo_bot_partner_identify"/>
            <field name="sequence">31</field>
            <field name="name">SaudaÃ§Ã£o GenÃ©rica</field>
            <field name="step_type">message</field>
            <field name="delay">1</field>
            <field name="message">OlÃ¡! ğŸ‘‹

Bem-vindo ao nosso atendimento!

Como posso te ajudar nesse momento?

Precisa falar com nosso time de:

1ï¸âƒ£ - Suporte
2ï¸âƒ£ - Comercial
3ï¸âƒ£ - Financeiro

Digite o nÃºmero da opÃ§Ã£o desejada.</field>
        </record>

        <!-- Step 4: Question - Aguardar Escolha -->
        <record id="demo_flow_wait_department" model="wa.bot.flow">
            <field name="bot_id" ref="demo_bot_partner_identify"/>
            <field name="sequence">40</field>
            <field name="name">Aguardar Escolha do Departamento</field>
            <field name="step_type">question</field>
            <field name="delay">0</field>
            <field name="message">Por favor, digite 1, 2 ou 3:</field>
            <field name="question_variable">department</field>
            <field name="question_validation">custom</field>
            <field name="validation_code">
# Validar se Ã© 1, 2 ou 3
if answer.strip() in ['1', '2', '3']:
    valid = True
else:
    valid = False
    error_message = "âŒ OpÃ§Ã£o invÃ¡lida! Por favor, digite 1 (Suporte), 2 (Comercial) ou 3 (Financeiro)."
            </field>
        </record>

        <!-- Step 5: Action - Processar Escolha e Preparar Mensagem -->
        <record id="demo_flow_process_choice" model="wa.bot.flow">
            <field name="bot_id" ref="demo_bot_partner_identify"/>
            <field name="sequence">50</field>
            <field name="name">Processar Escolha</field>
            <field name="step_type">action</field>
            <field name="delay">0</field>
            <field name="action_code">
# Mapear escolha para nome do departamento
department = session.get_variable('department')

department_map = {
    '1': 'Suporte TÃ©cnico',
    '2': 'Comercial',
    '3': 'Financeiro'
}

department_name = department_map.get(department, 'Atendimento')
session.set_variable('department_name', department_name)

# Mapear emoji
emoji_map = {
    '1': 'ğŸ”§',
    '2': 'ğŸ’¼',
    '3': 'ğŸ’°'
}

session.set_variable('department_emoji', emoji_map.get(department, 'ğŸ“‹'))
            </field>
        </record>

        <!-- Step 6: Message - ConfirmaÃ§Ã£o -->
        <record id="demo_flow_confirmation_department" model="wa.bot.flow">
            <field name="bot_id" ref="demo_bot_partner_identify"/>
            <field name="sequence">60</field>
            <field name="name">ConfirmaÃ§Ã£o de Redirecionamento</field>
            <field name="step_type">message</field>
            <field name="delay">1</field>
            <field name="message">{department_emoji} *{department_name}*

Perfeito, {partner_name}!

VocÃª foi direcionado para o setor de *{department_name}*.

Nossa equipe responderÃ¡ em breve! â±ï¸

Por favor, aguarde ou descreva sua solicitaÃ§Ã£o.</field>
        </record>

        <!-- Links entre os Steps -->
        
        <!-- Step 1 -> Step 2 -->
        <record id="demo_flow_identify_partner" model="wa.bot.flow">
            <field name="next_step_id" ref="demo_flow_check_partner"/>
        </record>

        <!-- Step 2 -> Step 3a (True) ou Step 3b (False) -->
        <record id="demo_flow_check_partner" model="wa.bot.flow">
            <field name="next_step_true_id" ref="demo_flow_greeting_known"/>
            <field name="next_step_false_id" ref="demo_flow_greeting_unknown"/>
        </record>

        <!-- Step 3a -> Step 4 -->
        <record id="demo_flow_greeting_known" model="wa.bot.flow">
            <field name="next_step_id" ref="demo_flow_wait_department"/>
        </record>

        <!-- Step 3b -> Step 4 -->
        <record id="demo_flow_greeting_unknown" model="wa.bot.flow">
            <field name="next_step_id" ref="demo_flow_wait_department"/>
        </record>

        <!-- Step 4 -> Step 5 -->
        <record id="demo_flow_wait_department" model="wa.bot.flow">
            <field name="next_step_id" ref="demo_flow_process_choice"/>
        </record>

        <!-- Step 5 -> Step 6 -->
        <record id="demo_flow_process_choice" model="wa.bot.flow">
            <field name="next_step_id" ref="demo_flow_confirmation_department"/>
        </record>

    </data>
</odoo>
